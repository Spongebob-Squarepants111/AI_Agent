# BCI Assistant - è„‘æœºæ¥å£æ™ºèƒ½åŠ©æ‰‹

åŸºäº OpenAI + LangChain çš„æ™ºèƒ½å¯¹è¯åŠ©æ‰‹ç³»ç»Ÿï¼Œæ”¯æŒ RAG çŸ¥è¯†å¢å¼ºå’Œç½‘ç»œæœç´¢åŠŸèƒ½ã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå¯æ‰©å±•çš„ AI åŠ©æ‰‹åç«¯æœåŠ¡ï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

- ğŸ¤– **æ™ºèƒ½å¯¹è¯** - åŸºäº OpenAI GPT çš„è‡ªç„¶è¯­è¨€å¯¹è¯
- ğŸ“š **RAG çŸ¥è¯†å¢å¼º** - æ”¯æŒ PDF/TXT/MD æ–‡æ¡£ä¸Šä¼ å’Œå‘é‡æ£€ç´¢
- ğŸ” **ç½‘ç»œæœç´¢** - é›†æˆ SerpAPI å®æ—¶æœç´¢äº’è”ç½‘ä¿¡æ¯
- ğŸ’¾ **ä¼šè¯è®°å¿†** - åŸºäº Redis çš„å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†
- ğŸŒŠ **æµå¼è¾“å‡º** - SSE (Server-Sent Events) å®æ—¶å“åº”
- ğŸ¯ **æ™ºèƒ½å†³ç­–** - è‡ªåŠ¨é€‰æ‹©æœ€ä½³å·¥å…·ï¼ˆçŸ¥è¯†åº“/æœç´¢ï¼‰

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯åº”ç”¨ (Vue 3)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTP/SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           FastAPI æœåŠ¡å™¨ (server.py)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SmartAgent (æ™ºèƒ½å†³ç­–)                       â”‚
â”‚  â”œâ”€ æ£€æµ‹çŸ¥è¯†åº“çŠ¶æ€                           â”‚
â”‚  â”œâ”€ è‡ªåŠ¨é€‰æ‹©å·¥å…·                             â”‚
â”‚  â””â”€ æµå¼å“åº”ç”Ÿæˆ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RAG æ¨¡å—                                    â”‚
â”‚  â”œâ”€ DocumentProcessor (æ–‡æ¡£å¤„ç†)            â”‚
â”‚  â”œâ”€ VectorStore (Qdrant å‘é‡å­˜å‚¨)           â”‚
â”‚  â””â”€ RAGRetriever (æ£€ç´¢å™¨)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥å…·æ¨¡å—                                    â”‚
â”‚  â””â”€ SearchTool (SerpAPI æœç´¢)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®°å¿†æ¨¡å—                                    â”‚
â”‚  â””â”€ ChatMemory (Redis ä¼šè¯ç®¡ç†)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ OpenAI â”‚    â”‚ Qdrant  â”‚    â”‚ Redis  â”‚
    â”‚  API   â”‚    â”‚(Memory) â”‚    â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.8+
- Redis (ç”¨äºä¼šè¯è®°å¿†)
- OpenAI API Key
- SerpAPI Key (å¯é€‰ï¼Œç”¨äºç½‘ç»œæœç´¢)

### 2. å®‰è£…ä¾èµ–

```bash
cd Ai_Agent
pip install -r requirements.txt
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# OpenAI é…ç½®
OPENAI_API_KEY=your_openai_api_key
OPENAI_API_BASE=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
TEMPERATURE=0.7

# Redis é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# Qdrant é…ç½® (ä½¿ç”¨å†…å­˜æ¨¡å¼ï¼Œæ— éœ€é¢å¤–é…ç½®)
QDRANT_COLLECTION=knowledge_base
CHUNK_SIZE=1000
CHUNK_OVERLAP=200

# SerpAPI é…ç½® (å¯é€‰)
SERPAPI_KEY=your_serpapi_key
```

### 4. å¯åŠ¨æœåŠ¡

```bash
python server.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨ã€‚

### 5. è®¿é—®åº”ç”¨

- **å‰ç«¯ç•Œé¢**: http://localhost:8000/
- **API æ–‡æ¡£**: http://localhost:8000/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/api

## ğŸ“¡ API æ¥å£

### 1. æ™ºèƒ½å¯¹è¯ (æµå¼)

```http
GET /agent_chat_stream?query=ä½ çš„é—®é¢˜&session_id=ä¼šè¯ID
```

**åŠŸèƒ½**: æ™ºèƒ½å¯¹è¯æ¥å£ï¼Œæ”¯æŒæµå¼è¾“å‡º

**å‚æ•°**:
- `query` (å¿…å¡«): ç”¨æˆ·é—®é¢˜
- `session_id` (å¯é€‰): ä¼šè¯IDï¼Œç”¨äºä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡

**å“åº”**: SSE æµå¼æ•°æ®

```javascript
// å‰ç«¯ç¤ºä¾‹
const eventSource = new EventSource(
  `/agent_chat_stream?query=${encodeURIComponent(query)}&session_id=${sessionId}`
);

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'content') {
    console.log(data.content); // æµå¼å†…å®¹
  }
};
```

### 2. ä¸Šä¼ æ–‡ä»¶åˆ°çŸ¥è¯†åº“

```http
POST /knowledge/upload_file
Content-Type: multipart/form-data

file: <æ–‡ä»¶>
```

**åŠŸèƒ½**: ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“

**æ”¯æŒæ ¼å¼**: PDF, TXT, MD

**å“åº”**:
```json
{
  "message": "æ–‡ä»¶ example.pdf å·²æ·»åŠ åˆ°çŸ¥è¯†åº“",
  "filename": "example.pdf",
  "chunks_added": 15
}
```

### 3. è·å–çŸ¥è¯†åº“ä¿¡æ¯

```http
GET /knowledge/info
```

**åŠŸèƒ½**: æŸ¥çœ‹çŸ¥è¯†åº“çŠ¶æ€

**å“åº”**:
```json
{
  "collection_name": "knowledge_base",
  "vectors_count": 150,
  "storage_mode": "memory"
}
```

## ğŸ§  SmartAgent å†³ç­–é€»è¾‘

SmartAgent ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨é€‰æ‹©æœ€ä½³å·¥å…·ï¼š

```
ç”¨æˆ·æé—®
    â”‚
    â–¼
æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦æœ‰æ–‡æ¡£ï¼Ÿ
    â”‚
    â”œâ”€ æœ‰æ–‡æ¡£ â”€â”€â†’ ä½¿ç”¨ RAG æ£€ç´¢ â”€â”€â†’ åŸºäºçŸ¥è¯†åº“å›ç­”
    â”‚
    â””â”€ æ— æ–‡æ¡£ â”€â”€â†’ ç›´æ¥å›ç­”
                    â”‚
                    â–¼
                AI è¡¨ç¤ºä¸çŸ¥é“ï¼Ÿ
                    â”‚
                    â”œâ”€ æ˜¯ â”€â”€â†’ è§¦å‘ç½‘ç»œæœç´¢ â”€â”€â†’ åŸºäºæœç´¢ç»“æœå›ç­”
                    â”‚
                    â””â”€ å¦ â”€â”€â†’ è¿”å›ç›´æ¥å›ç­”
```

### æ™ºèƒ½æœç´¢æŸ¥è¯¢ç”Ÿæˆ

å½“ç”¨æˆ·å›å¤ç®€çŸ­ï¼ˆå¦‚"éœ€è¦"ã€"æ˜¯çš„"ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»å¯¹è¯å†å²ä¸­æå–çœŸå®é—®é¢˜è¿›è¡Œæœç´¢ã€‚

**ç¤ºä¾‹**:
```
ç”¨æˆ·: "ä»Šå¤©é‡åº†æ¸©åº¦æ€ä¹ˆæ ·"
AI: "æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥æ‰¾å®æ—¶å¤©æ°”ä¿¡æ¯ï¼Œéœ€è¦å—ï¼Ÿ"
ç”¨æˆ·: "éœ€è¦"
ç³»ç»Ÿ: âœ… è‡ªåŠ¨æœç´¢ "ä»Šå¤©é‡åº†æ¸©åº¦æ€ä¹ˆæ ·" (è€Œä¸æ˜¯ "éœ€è¦")
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
Ai_Agent/
â”œâ”€â”€ server.py              # FastAPI æœåŠ¡å…¥å£ (202 è¡Œ)
â”œâ”€â”€ .env                   # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ README.md              # é¡¹ç›®æ–‡æ¡£
â”‚
â”œâ”€â”€ agent/                 # Agent æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ smart_agent.py     # æ™ºèƒ½å†³ç­– Agent
â”‚
â”œâ”€â”€ rag/                   # RAG çŸ¥è¯†å¢å¼ºæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ document_processor.py  # æ–‡æ¡£å¤„ç† (PDF/TXT)
â”‚   â”œâ”€â”€ vector_store.py        # Qdrant å‘é‡å­˜å‚¨
â”‚   â””â”€â”€ retriever.py           # RAG æ£€ç´¢å™¨
â”‚
â”œâ”€â”€ tools/                 # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ search.py          # SerpAPI æœç´¢å·¥å…·
â”‚
â””â”€â”€ memory/                # è®°å¿†æ¨¡å—
    â”œâ”€â”€ __init__.py
    â””â”€â”€ session_memory.py  # Redis ä¼šè¯è®°å¿†
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### SmartAgent (agent/smart_agent.py)

æ™ºèƒ½å†³ç­–å¼•æ“ï¼Œè´Ÿè´£ï¼š
- æ£€æµ‹çŸ¥è¯†åº“çŠ¶æ€
- è‡ªåŠ¨é€‰æ‹©å·¥å…·ï¼ˆRAG/æœç´¢ï¼‰
- æ£€æµ‹ AI å›ç­”æ˜¯å¦è¡¨ç¤º"ä¸çŸ¥é“"
- ç”Ÿæˆæ™ºèƒ½æœç´¢æŸ¥è¯¢
- æµå¼å“åº”ç”Ÿæˆ

**å…³é”®æ–¹æ³•**:
- `chat_stream()` - æµå¼å¯¹è¯å¤„ç†
- `_check_if_unknown()` - æ£€æµ‹"ä¸çŸ¥é“"å›ç­”
- `_generate_search_query()` - æ™ºèƒ½æœç´¢æŸ¥è¯¢ç”Ÿæˆ

### RAGRetriever (rag/retriever.py)

RAG æ£€ç´¢å™¨ï¼Œæä¾›ï¼š
- `add_pdf()` - æ·»åŠ  PDF æ–‡æ¡£
- `add_text_file()` - æ·»åŠ æ–‡æœ¬æ–‡ä»¶
- `get_context()` - è·å–ç›¸å…³ä¸Šä¸‹æ–‡
- `get_collection_info()` - è·å–çŸ¥è¯†åº“ä¿¡æ¯

### SearchTool (tools/search.py)

ç½‘ç»œæœç´¢å·¥å…·ï¼Œæä¾›ï¼š
- `search()` - æ‰§è¡Œæœç´¢
- `get_search_context()` - è·å–æœç´¢ç»“æœä¸Šä¸‹æ–‡

### ChatMemory (memory/session_memory.py)

ä¼šè¯è®°å¿†ç®¡ç†ï¼Œæä¾›ï¼š
- `add_message()` - æ·»åŠ æ¶ˆæ¯
- `get_history_messages()` - è·å–å†å²æ¶ˆæ¯
- `clear()` - æ¸…ç©ºå†å²

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: çº¯å¯¹è¯

```
ç”¨æˆ·: "ä½ å¥½"
ç³»ç»Ÿ: ç›´æ¥å›ç­”ï¼ˆæ— éœ€å·¥å…·ï¼‰
```

### åœºæ™¯ 2: çŸ¥è¯†åº“é—®ç­”

```
ç”¨æˆ·: ä¸Šä¼  PDF æ–‡æ¡£
ç”¨æˆ·: "æ–‡æ¡£ä¸­æåˆ°çš„ä¸»è¦è§‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"
ç³»ç»Ÿ: ä½¿ç”¨ RAG æ£€ç´¢ â†’ åŸºäºæ–‡æ¡£å†…å®¹å›ç­”
```

### åœºæ™¯ 3: ç½‘ç»œæœç´¢

```
ç”¨æˆ·: "2024å¹´è¯ºè´å°”ç‰©ç†å­¦å¥–å¾—ä¸»æ˜¯è°ï¼Ÿ"
ç³»ç»Ÿ: AI è¡¨ç¤ºä¸çŸ¥é“ â†’ è§¦å‘æœç´¢ â†’ åŸºäºæœç´¢ç»“æœå›ç­”
```

### åœºæ™¯ 4: å¤šè½®å¯¹è¯

```
ç”¨æˆ·: "ä»Šå¤©é‡åº†å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
AI: "æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥æ‰¾ï¼Œéœ€è¦å—ï¼Ÿ"
ç”¨æˆ·: "éœ€è¦"
ç³»ç»Ÿ: ä»å†å²æå–çœŸå®é—®é¢˜ â†’ æœç´¢ "ä»Šå¤©é‡åº†å¤©æ°”æ€ä¹ˆæ ·"
```

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æ—¥å¿—è¾“å‡º

æœåŠ¡è¿è¡Œæ—¶ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
[INFO] RAG retriever initialized successfully
[INFO] Search tool initialized successfully
[INFO] Smart Agent initialized successfully
[DEBUG] /agent_chat_stream called with query: ä½ çš„é—®é¢˜
[INFO] Knowledge base has 0 vectors
[DEBUG] LLM stream response: AIçš„å›ç­”
[DEBUG] Detected 'unknown' response, matched keywords: ['ä¸çŸ¥é“']
[INFO] AI doesn't know, using web search
[DEBUG] Generated search query: ä¼˜åŒ–åçš„æœç´¢æŸ¥è¯¢
```

### çŸ¥è¯†åº“çŠ¶æ€

```bash
curl http://localhost:8000/knowledge/info
```

## ğŸ“ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `tools/` ç›®å½•åˆ›å»ºæ–°å·¥å…·ç±»
2. åœ¨ `SmartAgent` ä¸­é›†æˆå·¥å…·
3. æ›´æ–°å†³ç­–é€»è¾‘

### æ‰©å±•æ–‡æ¡£ç±»å‹

1. åœ¨ `DocumentProcessor` ä¸­æ·»åŠ æ–°çš„ `load_xxx()` æ–¹æ³•
2. åœ¨ `RAGRetriever` ä¸­æ·»åŠ å¯¹åº”çš„ `add_xxx()` æ–¹æ³•
3. åœ¨ `server.py` ä¸­æ·»åŠ  API ç«¯ç‚¹

### è‡ªå®šä¹‰ Agent è¡Œä¸º

ä¿®æ”¹ `agent/smart_agent.py` ä¸­çš„ï¼š
- `system_prompt` - ç³»ç»Ÿæç¤ºè¯
- `_check_if_unknown()` - "ä¸çŸ¥é“"æ£€æµ‹é€»è¾‘
- `_generate_search_query()` - æœç´¢æŸ¥è¯¢ç”Ÿæˆé€»è¾‘

## ğŸ› å¸¸è§é—®é¢˜

### 1. Redis è¿æ¥å¤±è´¥

ç¡®ä¿ Redis æœåŠ¡å·²å¯åŠ¨ï¼š
```bash
redis-server
```

### 2. OpenAI API è°ƒç”¨å¤±è´¥

æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ API Key å’Œ Base URL æ˜¯å¦æ­£ç¡®ã€‚

### 3. æœç´¢åŠŸèƒ½ä¸å·¥ä½œ

ç¡®ä¿ `.env` ä¸­é…ç½®äº† `SERPAPI_KEY`ã€‚

### 4. çŸ¥è¯†åº“æ£€ç´¢æ— ç»“æœ

æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ æ–‡æ¡£ï¼š
```bash
curl http://localhost:8000/knowledge/info
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**æœ€åæ›´æ–°**: 2026-01-30
**ç‰ˆæœ¬**: 2.0.0 (ç²¾ç®€ç‰ˆ)
